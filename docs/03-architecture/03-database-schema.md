# Database Schema

Complete reference for the Mail History database schema.

## Table: mail_histories

### Schema

```sql
CREATE TABLE `mail_histories` (
    `id` bigint unsigned NOT NULL AUTO_INCREMENT,
    `uuid` char(36) NOT NULL,
    `hash` varchar(255) NOT NULL,
    `status` varchar(255) NOT NULL DEFAULT 'Sending' COMMENT 'Sending, Sent',
    `headers` json DEFAULT NULL,
    `body` text DEFAULT NULL,
    `content` json NOT NULL COMMENT 'Default we have text, text-charset and html key',
    `meta` json DEFAULT NULL,
    `created_at` timestamp NULL DEFAULT NULL,
    `updated_at` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`id`),
    KEY `mail_histories_hash_index` (`hash`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### Column Descriptions

#### id

- **Type:** BIGINT UNSIGNED
- **Auto Increment:** Yes
- **Primary Key:** Yes
- **Description:** Unique identifier for each record

#### uuid

- **Type:** CHAR(36)
- **Description:** UUID for external reference and identification
- **Generated By:** `InteractsWithUuid` trait
- **Format:** Standard UUID format (e.g., `550e8400-e29b-41d4-a716-446655440000`)

#### hash

- **Type:** VARCHAR(255)
- **Indexed:** Yes
- **Description:** SHA-1 hash for tracking email lifecycle
- **Generated By:** `configureMetadataHash()` method
- **Usage:** Links "Sending" and "Sent" records

#### status

- **Type:** VARCHAR(255)
- **Default:** `Sending`
- **Allowed Values:**
  - `Sending` - Email is being prepared or queued
  - `Sent` - Email has been successfully sent
- **Description:** Current state of the email

#### headers

- **Type:** JSON
- **Nullable:** Yes
- **Description:** Complete email headers
- **Contains:**
  - Subject
  - From/To addresses
  - CC/BCC recipients
  - Content-Type
  - Message-ID
  - Date
  - Reply-To
  - Custom headers

**Example:**

```json
{
    "Subject": "Welcome to Our App",
    "From": "noreply@app.com",
    "To": "user@example.com",
    "Cc": "admin@app.com",
    "Content-Type": "text/html; charset=utf-8",
    "Message-ID": "<abc123@mail.app.com>",
    "Date": "Mon, 16 Nov 2025 10:00:00 +0000",
    "X-Mailer": "Laravel"
}
```

#### body

- **Type:** TEXT
- **Nullable:** Yes
- **Description:** Plain text email body
- **Usage:** Stores the text version of the email for quick access

#### content

- **Type:** JSON
- **Required:** Yes
- **Description:** Structured email content with both text and HTML versions

**Structure:**

```json
{
    "text": "Plain text version of the email...",
    "text-charset": "utf-8",
    "html": "<html><body>HTML version of email...</body></html>"
}
```

#### meta

- **Type:** JSON
- **Nullable:** Yes
- **Description:** Additional metadata including tracking hash

**Default Structure:**

```json
{
    "hash": "3a4f5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a"
}
```

**Can Be Extended:**

```json
{
    "hash": "3a4f5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a",
    "order_id": 12345,
    "user_id": 67890,
    "campaign": "welcome-series"
}
```

#### created_at

- **Type:** TIMESTAMP
- **Nullable:** Yes
- **Description:** When the record was created (email started sending)

#### updated_at

- **Type:** TIMESTAMP
- **Nullable:** Yes
- **Description:** When the record was last updated (typically when status changed to "Sent")

## Indexes

### Primary Key

- **Column:** `id`
- **Type:** BTREE
- **Usage:** Fast record lookup by ID

### Hash Index

- **Column:** `hash`
- **Type:** BTREE
- **Usage:** Fast lookup by tracking hash
- **Queries Optimized:**
  - Finding records by hash
  - Updating status from Sending to Sent
  - Tracking email lifecycle

## Data Types

### JSON Columns

The schema uses JSON columns for flexible data storage:

- **headers** - Variable email headers
- **content** - Both text and HTML versions
- **meta** - Extensible metadata

### TEXT Column

- **body** - Can store large email bodies without length limitations

### VARCHAR Columns

- **hash** - Fixed-length SHA-1 hash (40 characters) with room for custom hashes
- **status** - Enum-like values (Sending/Sent)

## Storage Considerations

### Size Estimates

Typical record size:

- Headers: 1-5 KB
- Body: 1-10 KB
- Content: 2-20 KB
- Meta: < 1 KB
- **Total: 5-40 KB per record**

### Growth Calculations

For an application sending 1,000 emails per day:

- **Daily:** ~20 MB
- **Monthly:** ~600 MB
- **Yearly:** ~7 GB

Plan database storage accordingly.

### Optimization

For high-volume applications:

1. **Regular Cleanup:**

   ```sql
   DELETE FROM mail_histories WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
   ```

2. **Partitioning:**
   - Partition by created_at date
   - Archive old partitions

3. **Separate Database:**
   - Use dedicated database connection for mail history

## Querying Examples

### By Status

```php
// Get all sent emails
MailHistory::where('status', 'Sent')->get();

// Get emails still sending
MailHistory::where('status', 'Sending')->get();
```

### By Hash

```php
// Find by hash
MailHistory::where('hash', $hash)->first();

// Check if email was sent
$sent = MailHistory::where('hash', $hash)
    ->where('status', 'Sent')
    ->exists();
```

### By Date

```php
// Today's emails
MailHistory::whereDate('created_at', today())->get();

// Last 7 days
MailHistory::where('created_at', '>=', now()->subDays(7))->get();

// Between dates
MailHistory::whereBetween('created_at', [$start, $end])->get();
```

### By JSON Content

```php
// Search headers
MailHistory::whereJsonContains('headers->Subject', 'Welcome')->get();

// Search meta
MailHistory::whereJsonContains('meta->order_id', 123)->first();

// Search by recipient
MailHistory::whereJsonContains('headers->To', 'user@example.com')->get();
```

### Complex Queries

```php
// Failed emails (stuck in Sending)
MailHistory::where('status', 'Sending')
    ->where('created_at', '<', now()->subHours(2))
    ->get();

// Emails sent today to specific domain
MailHistory::where('status', 'Sent')
    ->whereDate('created_at', today())
    ->where('headers->To', 'like', '%@example.com')
    ->get();
```

## Model Relationships

The base model doesn't define relationships, but you can extend it:

```php
namespace App\Models;

use CleaniqueCoders\MailHistory\Models\MailHistory as BaseMailHistory;

class MailHistory extends BaseMailHistory
{
    // Add relationship to users
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id', 'id');
    }

    // Add relationship to orders
    public function order()
    {
        return $this->belongsTo(Order::class, 'order_id', 'id');
    }

    // Extract order_id from meta
    public function getOrderIdAttribute()
    {
        return data_get($this->meta, 'order_id');
    }

    // Extract user_id from meta
    public function getUserIdAttribute()
    {
        return data_get($this->meta, 'user_id');
    }
}
```

## Migration

The package provides a migration stub:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('mail_histories', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid');
            $table->string('hash')->index();
            $table->string('status')
                ->default('Sending')
                ->comment('Sending, Sent');
            $table->json('headers')->nullable();
            $table->text('body')->nullable();
            $table->json('content')
                ->comment('Default we have text, text-charset and html key');
            $table->json('meta')->nullable();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('mail_histories');
    }
};
```

Publish and run:

```bash
php artisan vendor:publish --tag="mailhistory-migrations"
php artisan migrate
```

## Database Configuration

### Connection

Use default connection or specify custom:

```php
// In extended model
protected $connection = 'mailhistory';
```

Then configure in `config/database.php`:

```php
'connections' => [
    'mailhistory' => [
        'driver' => 'mysql',
        'host' => env('MAILHISTORY_DB_HOST', '127.0.0.1'),
        'database' => env('MAILHISTORY_DB_DATABASE', 'mail_history'),
        'username' => env('MAILHISTORY_DB_USERNAME', 'root'),
        'password' => env('MAILHISTORY_DB_PASSWORD', ''),
    ],
],
```

### Table Name

Default table name is `mail_histories`. To customize:

```php
// In extended model
protected $table = 'custom_mail_history';
```

## Backup and Maintenance

### Backup Strategy

```bash
# Backup mail histories table
mysqldump -u user -p database mail_histories > mail_histories_backup.sql

# Backup with compression
mysqldump -u user -p database mail_histories | gzip > mail_histories_backup.sql.gz
```

### Archive Old Records

```php
// Archive records older than 90 days
$records = MailHistory::where('created_at', '<', now()->subDays(90))->get();

// Export to CSV
$csv = fopen('archive.csv', 'w');
foreach ($records as $record) {
    fputcsv($csv, $record->toArray());
}
fclose($csv);

// Delete archived records
MailHistory::where('created_at', '<', now()->subDays(90))->delete();
```

### Optimize Table

```sql
OPTIMIZE TABLE mail_histories;
```

## Next Steps

- Check the [Configuration Reference](./04-configuration-reference.md)
- Learn about [Testing](../04-advanced/02-testing.md)
- See [Troubleshooting Guide](../04-advanced/03-troubleshooting.md)
